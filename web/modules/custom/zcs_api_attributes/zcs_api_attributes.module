<?php

/**
 * @file
 */

use Drupal\Core\Render\Markup;
use Drupal\group\Entity\Group;


/**
 * @file
 * Primary module hooks for zcs_api_attributes module.
 */

/**
 *
 */
function zcs_api_attributes_theme() {
  return [
    'attributes_page' => [
      'variables' => [
        'content' => NULL,
      ],
      'template' => 'attributes_page',
    ],
    'change_network_authentication_pricing' => [
      'variables' => [
        'content' => NULL,
      ],
      'template' => 'change_network_authentication_pricing',
    ],
    'network_authentication_pricing_over_time' => [
      'variables' => [
        'content' => NULL,
      ],
      'template' => 'network_authentication_pricing_over_time',
    ],
    'demand_partner_discounts_or_different_pricing' => [
      'variables' => [
        'content' => NULL,
      ],
      'template' => 'demand_partner_discounts_or_different_pricing',
    ],
    'rate_sheet' => [
      'render element' => 'form',
      'template' => 'rate_sheet',
    ],
    'rate_sheet_approval' => [
      'variables' => [
        'content' => NULL,
      ],
      'template' => 'rate_sheet_approval',
    ],
    'api_attribute_sheet_approval' => [
      'variables' => [
        'content' => NULL,
      ],
      'template' => 'api_attribute_sheet_approval',
    ],
    'rate_sheet_review' => [
      'render element' => 'form',
      'template' => 'rate_sheet_review',
    ],
    'api_attribute_status_review' => [
      'render element' => 'form',
      'template' => 'api_attribute_status_review',
    ],
    'api_attribute_sheet' => [
      'render element' => 'form',
      'template' => 'api_attribute_sheet',
    ],
  ];
}

/**
 * Implements hook_mail().
 */
function zcs_api_attributes_mail($key, &$message, $params) {
  $options = [
    'langcode' => $message['langcode'],
  ];
  switch ($key) {
    case 'rate_sheet':
      $message['from'] = \Drupal::config('system.site')->get('mail');
      $message['subject'] = t('Price Plan Rate sheet Requested for Approval', $options);
      $message['body'][] = Markup::create($params['message']);
      $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed; delsp=yes';
      break;

    case 'api_attribute_sheet':
      $message['from'] = \Drupal::config('system.site')->get('mail');
      $message['subject'] = t('API Attribute Status sheet Requested for Approval', $options);
      $message['body'][] = Markup::create($params['message']);
      $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed; delsp=yes';
      break;
  }
}

/**
 *
 */
function zcs_api_attributes_preprocess_html(&$variables) {
  if (\Drupal::routeMatch()->getRouteName() == 'zcs_api_attributes.attribute.page') {
    $variables['attributes']['class'][] = 'api-attribute-status';
  }
  if (\Drupal::routeMatch()->getRouteName() == 'zcs_api_attributes.pricing_history') {
    $variables['attributes']['class'][] = 'network_authentication_pricing_over_time';
  }

}


/**
 * Implements hook_cron().
 */
function zcs_api_attributes_cron() {
    \Drupal::logger('RMP-step-1')->notice("cron initiated");
    // Step: 1 get the partner lists tagged with ENTERPISE value
    $partner_details_result = [];
    $query = \Drupal::entityQuery('group')->condition('field_partner_type', 'enterprise');
    $gids = $query->accessCheck(FALSE)->execute();
    $groups = Group::loadMultiple($gids);
    foreach ($groups as $group) {
        $partner_details_result[] = [
            'gid' => $group->id(),
            'title' => $group->label(),
            'pricing_type' => $group->get('field_pricing_type')->value,
        ];
    }
    //create queue for retail price percentage calculation.
    createRetailPricePercentageQueue($partner_details_result);
}


function  createRetailPricePercentageQueue($partner_details_result) {
  $data_for_calculation = [];
  $queue_factory = \Drupal::service('queue');
  $queue = $queue_factory->get('retail_markup_percentage');
  $number = $queue->numberOfItems();
  \Drupal::logger('RMP-step-no-of-items')->notice($number);
  if($number == 0) {
    \Drupal::logger('RMP-step-2-processing')->notice("Cron Queue Processing");
    // Step: 2: Get the list of analytic nodes for the respective partners.
    foreach($partner_details_result as $key => $partner) {  
      $item = new \stdClass();
      $item->gid = $partner['gid'];
      $item->partner_title = $partner['title'];
      $item->price_type = $partner['pricing_type'];
      $queue->createItem($item);
    }
  }
}
