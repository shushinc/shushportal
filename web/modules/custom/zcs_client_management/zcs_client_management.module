<?php

/**
 * @file
 * Primary module hooks for zcs Client Management module.
 */
use Drupal\Core\Render\Markup;

/**
 * Implements hook_theme().
 */
function zcs_client_management_theme($existing, $type, $theme, $path) {
    return [
      'client_view' => [
        'variables' => [
          'image_url' => '',  
          'client_name' => '',
          'contact_name' => '',
          'contact_email' => '',
          'status' => '',
          'description' => '',
          'client_legal_contact' => '',
          'legal_email' => '',
          'address' => '',
          'type' => '',
          'industry' => '',
          'agreement_effective_date' => '',
          'currency' => '',
          'prepayment_amount' => '',
          'prepayment_balance_left' => '',
          'prepayment_balance_used' => '',
          'address_line_1' => '',
          'address_line_2' => '',
          'address_line_3' => '', 
          'country_code' => '',
          'postal_code' => '',
          'agreement_covers' => '',
        ],
        'template' => 'client-view',
      ],
    ];
  }



/**
 * Implements hook_mail().
 */
function zcs_client_management_mail($key, &$message, $params) {
    $email_from = \Drupal::config('system.site')->get('mail');
    switch ($key) {
        case 'client_member_invite':
            $message['from'] = \Drupal::config('system.site')->get('mail');
            $message['subject'] = $params['subject'];
            $message['body'][] = $params['message'];
            break;
    }
}



function zcs_client_management_preprocess_views_view_field(&$variables) {
  if ($variables['view']->id() === 'user_management' && $variables['view']->current_display === 'page_1') {
    if (!empty($variables['row']->_entity) && $variables['row']->_entity->hasField('roles') && $variables['field']->field == 'roles_target_id') {
      $entity = $variables['row']->_entity;
      // Get referenced role entities
      $roles = $entity->get('roles')->referencedEntities();
      // Collect role labels
      $role_names = [];
      foreach ($roles as $role) {
        $role_names[] = $role->label();
      }
      // Join array into a string for output
      $roles_string = implode(', ', $role_names);

      $max_length = '20';
      if (mb_strlen($roles_string) > $max_length) {
        $trimmed = mb_substr($roles_string, 0, $max_length) . '...';
      } else {
        $trimmed = $roles_string;
      }
  // Tooltip with inline CSS
  $tooltip_icon = '
    <span style="position:relative; display:inline-block; cursor:pointer; color:#888; margin-left:5px;">
      <i class="fa fa-info-circle" aria-hidden="true"></i>
      <span style="
      visibility:hidden;
      opacity:0;
      background:#333;
      color:#fff;
      text-align: center;
      padding:5px 8px;
      border-radius:6px;
      position:absolute;
      z-index:99;
      bottom:125%;
      left:50%;
      transform:translateX(-50%);
      transition:opacity 0.3s;
      width:250px;         /* fixed width */
      white-space:normal;  /* allow wrapping */
      word-break:keep-all; /* donâ€™t break inside words */
      line-height:1.4;     /* paragraph look */
      " class="tooltip-text">' . htmlspecialchars($roles_string, ENT_QUOTES, 'UTF-8') . '</span>
    </span>

    <script>
      (function() {
        var container = document.currentScript.previousElementSibling;
        var tooltip = container.querySelector(".tooltip-text");
        container.addEventListener("mouseenter", function() {
          tooltip.style.visibility = "visible";
          tooltip.style.opacity = "1";
        });
        container.addEventListener("mouseleave", function() {
          tooltip.style.visibility = "hidden";
          tooltip.style.opacity = "0";
        });
      })();
    </script>
  ';

      // Final output
      $output = '<span>' . $trimmed . '</span>';

     
      $output .= $tooltip_icon;
   

      $variables['output'] = Markup::create($output);
    }
  }
}